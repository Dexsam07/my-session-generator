const express = require('express'); const { default: makeWASocket, DisconnectReason, useMultiFileAuthState } = require('@whiskeysockets/baileys'); const path = require('path'); const fs = require('fs'); const app = express(); app.use(express.static(__dirname)); app.use(express.json()); let sock; const storePath = './session'; app.get('/qr', async (req, res) => { if (sock) { await sock.logout(); sock = null; } const { state, saveCreds } = await useMultiFileAuthState(storePath); sock = makeWASocket({ auth: state }); sock.ev.on('creds.update', saveCreds); sock.ev.on('connection.update', (update) => { if (update.qr) res.end(update.qr); if (update.connection === 'open') res.redirect('/'); }); }); app.post('/pair', async (req, res) => { const { number } = req.body; const num = number.startsWith('+') ? number : +${number}; if (sock) { await sock.logout(); sock = null; } const { state, saveCreds } = await useMultiFileAuthState(storePath); sock = makeWASocket({ auth: state, printQRInTerminal: false }); sock.ev.on('creds.update', saveCreds); const code = await sock.requestPairingCode(num); res.json({ code }); }); app.get('/session', async (req, res) => { const fullPath = path.join(storePath, 'creds.json'); if (fs.existsSync(fullPath)) { const data = fs.readFileSync(fullPath, 'utf8'); res.set('Content-Type', 'application/json').send(data); } else { res.status(404).json({ error: 'session not found' }); } }); app.listen(3000);
